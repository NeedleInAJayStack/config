- hosts: localhost
  tasks:
    - name: Add apt repositories
      ansible.builtin.apt_repository:
        repo: "{{ item }}"
      become: true
      loop:
        - ppa:fish-shell/release-3
        - ppa:neovim-ppa/stable
    
    - name: Update apt
      ansible.builtin.apt:
        update_cache: yes
      become: true

    - name: Install apt packages
      ansible.builtin.apt:
        name: "{{ item }}"
        state: present
      loop:
        - fzf
        - htop
        - jq
        - neovim
      become: true

    - name: Install stable snaps
      community.general.snap:
        name:
          - yq
      become: true

    - name: Install edge snaps
      community.general.snap:
        name: 
          - starship
        channel: edge # starship isn't available as a stable snap atm
      become: true
    
    # TODO: LSD is only available in Ubuntu 23.04 :(
    - name: Install lsd
      ansible.builtin.apt:
        name: lsd
        state: present
      become: true
      register: lsd_install_result

    # TODO: Figure out how to install nerd fonts on Ubuntu

    - name: Install fish
      ansible.builtin.apt:
        name: fish
        state: present
      register: fish_install_result

    - name: Add fish to shells
      lineinfile:
        path: /etc/shells
        line: "/opt/homebrew/bin/fish"
        state: present
      become: true
    - name: Check for fisher
      shell: fish --command "fisher -v"
      ignore_errors: yes
      register: fisher_check_result
      changed_when: fisher_check_result.failed
    - name: Install fisher
      shell: fish --command "curl -sL https://raw.githubusercontent.com/jorgebucaran/fisher/main/functions/fisher.fish | source && fisher install jorgebucaran/fisher"
      when: fisher_check_result.failed

    - name: Add starship init to fish
      lineinfile:
        path: ~/.config/fish/config.fish
        line: "starship init fish | source"
        state: present

    - name: Link neovim config
      file:
        src: ~/dev/config/nvim
        dest: ~/.config/nvim
        state: link

    - name: Add alias if lsd was installed or changed
      shell: |
        fish --command="alias --save ls='lsd'"
      when: lsd_install_result.changed